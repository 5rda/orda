{% extends 'base.html' %}
{% block content %}
  <ul>
    <li>{{ mountain.pk }}</li>
    <li>{{ mountain.name }}</li>
    <div id="mountain-map" style="width:500px;height:400px;"></div>
    <li>{{ mountain.region }}</li>
    <li>{{ mountain.height }}</li>
    <li id="latitude">{{ mountain.geom.y }}</li>
    <li id="longitude">{{ mountain.geom.x }}</li>
  </ul>
  <br>
  <hr>
  <h2>course</h2>
  <ul>
    {% for course in courses %}
        <li>코스명: {{ course.crs_name }}</li>
        <div id="map-{{ course.pk }}" style="width: 100%; height: 300px;"></div>
        <li>총거리: {{ course.distance }}m</li>
        <li>소요시간: {{ course.duration }}</li>
        <br>
        <hr>
    {% empty %}
        <li>No courses available.</li>
    {% endfor %}
  </ul>

  <!-- 카카오맵 API 로드 -->
  <script type="text/javascript">
    function loadKakaoMapScript(callback) {
        if (window.kakao) {
            // 이미 카카오맵 API가 로드되어 있는 경우
            callback();
        } else {
            // 카카오맵 API 로드
            var script = document.createElement("script");
            script.type = "text/javascript";
            script.src = "https://dapi.kakao.com/v2/maps/sdk.js?appkey=d39fcd60ffdc96ae99454337f5e45a16&libraries=services&autoload=false";
            document.head.appendChild(script);
            
            script.onload = function () {
                kakao.maps.load(function () {
                    callback();
                });
            };
        }
    }
    // 카카오맵 초기화 함수
    function initMap(courseId, courseDetail) {
      var container = document.getElementById('map-' + courseId);
      var options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), 
        level: 6
      };
      var map = new kakao.maps.Map(container, options);
    
      var linePath = [];
      var waypointPositions = [];

      // 해당 코스의 CourseDetail들에 대해 위치 표시 및 linePath에 좌표 추가
      courseDetail.features.forEach(function(feature) {
        var coordinates = feature.geometry.coordinates;
        var x = coordinates[0];
        var y = coordinates[1];
    
        if (!feature.properties.is_waypoint) {
          linePath.push(new kakao.maps.LatLng(y, x));
        } else {
          waypointPositions.push(new kakao.maps.LatLng(y, x));
          
          // 마커를 표시합니다
          var waypointName = feature.properties.waypoint_name;
          waypointPositions.forEach(function (position, index) {
            var marker = new kakao.maps.Marker({
              position: position,
              map: map,
              title: waypointName
            });
          });
        
        }
      });
    
      // 중간 인덱스 계산
      var middleIndex = Math.floor(linePath.length / 2);
      var center = linePath[middleIndex];
    
      // Polyline을 이용하여 선 그리기
      var polyline = new kakao.maps.Polyline({
        path: linePath, // linePath에 저장된 좌표들로 설정
        strokeWeight: 3,
        strokeColor: '#FF0000',
        strokeOpacity: 0.7,
        strokeStyle: 'solid'
      });
      polyline.setMap(map);
    
      // 부드럽게 마커가 위치한 곳으로 이동합니다
      map.panTo(center);
    }


// 산 좌표를 찍는 카카오 MAP
function showMountainMarker(latitude, longitude) {
  var container = document.getElementById('mountain-map');
  var options = {
    center: new kakao.maps.LatLng(latitude, longitude),
    level: 10
  };
  var map = new kakao.maps.Map(container, options);

  var markerPosition = new kakao.maps.LatLng(latitude, longitude);

  var marker = new kakao.maps.Marker({
    position: markerPosition
  });

  marker.setMap(map);

  // 지도 중심을 마커의 위치로 이동합니다
  map.setCenter(markerPosition);

  // 부드럽게 마커가 위치한 곳으로 이동합니다
  map.panTo(markerPosition);
}

  // 카카오맵 API 로드 후 초기화 함수 호출
  loadKakaoMapScript(function () {
    {% for course in courses %}
      var courseId = {{ course.pk }};
        var courseDetails = {{ course_details|safe }};
        var courseDetail = JSON.parse(courseDetails[courseId]);
        initMap(courseId, courseDetail);
    {% endfor %}

    // 산의 위치에 마커 표시
    var mountainLatitude = parseFloat(document.getElementById('latitude').textContent);
    var mountainLongitude = parseFloat(document.getElementById('longitude').textContent);
    showMountainMarker(mountainLatitude, mountainLongitude);

  });

</script>
  {% endblock content %}
