{% load static %}
{% load custom_filters %}
<link rel="stylesheet" href="{% static 'css/base.css' %}">
<style>
  a {
    text-decoration: none;
    color: inherit;
  }
  
  .list-group,
  .list-group-item {
    font-size: 13px;
  }

  .notification-popup {
    position: absolute;
    top: 60px;
    right: 100px;
    z-index: 800;
    background-color: rgba(255, 255, 255, 0);
    width: 350px;
    height: 300px;
  }
</style>
<header style="position: relative; top: 0; z-index: 1000;">
  <div style="height: 100%; box-shadow: 0px 3px 5px var(--main-color); background-color: #FFFFFF;">
    <div class="container">
      <div class="header__nav--warp">
        <div class="header__logo"><a href="{% url 'index' %}"><img class='header__logo--img' src="{% static 'img/nav_logo.png' %}" alt="ordalogo"></a></div>
        <div class="header__navbox1">
          <ul class="header__nav--list">
            <li class="header__nav--item">
              <a id="탐색" class="{% if active_button_id == '탐색' %}active-button{% endif %}" href="{% url 'mountains:search' %}">탐색</a>
            </li>
            <li class="header__nav--item">
              <a id="마이코스" class="{% if active_button_id == '마이코스' %}active-button{% endif %}" href="{% url 'posts:index' %}">마이코스</a>
            </li>
            <li class="header__nav--item">
              <a id="등산로" class="{% if active_button_id == '등산로' %}active-button{% endif %}" href="{% url 'mountains:course_all_list' %}">등산로</a>
            </li>
            <li class="header__nav--item">
              <a id="인증샷" class="{% if active_button_id == '인증샷' %}active-button{% endif %}" href="{% url 'posts:proofshot' %}">인증샷</a>
            </li>
          </ul>
        </div>
        <div class="header__navbox2">
          <div class="header__search">
            <div class="header__search--list">
              <div>
                <svg id="i-search" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="18" height="18" fill="none" stroke="#B2B2B2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                  <circle cx="14" cy="14" r="12" />
                  <path d="M23 23 L30 30"  />
                </svg>
              </div>
              <form action="{% url 'mountains:mountain_list' %}" method="POST">
                {% csrf_token %}
                <input class="header__search--text" type="text" name="search_query" placeholder="무엇을 찾으시나요?">
                <button type="submit" hidden></button>
              </form>
            </div>
          </div>
          <div class="header__user--list">
            {% if user.is_authenticated %}
              <div class="header__user--item">
                <button id="마이페이지" class="{% if active_button_id == '마이페이지' %}active-button{% endif %}"><a href="{% url 'accounts:profile' user.pk %}">마이페이지</a></button>
              </div>
              <div class="header__user--item">
                <form action="{% url 'accounts:logout' %}" method="POST">
                  {% csrf_token %}
                  <button id="로그아웃" type="submit">로그아웃</button>
                </form>
              </div>
              <div class="header__user--item">
                <form action="{% url 'posts:create' %}" method="POST">
                  {% csrf_token %}
                  <button id="마이코스 작성" type="submit">마이코스 작성</button>
                </form>
              </div>
              <div class="header__user--item">
                <button id="notification-button" onclick="toggleNotificationPopup()"><span id="notification-count">
                  {% if request.notification_count %}
                    <span id="fill"><i class="bi bi-bell-fill"></i></span>
                  {% else %}
                    <span id= "empty"><i class="bi bi-bell"></i></span>
                  {% endif %}</span>
                </button>
                <div id="notification-popup" class="notification-popup" style="display: none;">
                  <ul class="list-group" id="notification-list">
                    <div id="notification-container" class="notification-container"></div>
                  </ul>
                </div>
              </div>
              </div>
            {% else %}
              <div class="header__user--item">
                <button id="로그인" class="{% if active_button_id == '로그인' %}active-button{% endif %}"><a href="{% url 'accounts:login' %}">로그인</a></button>
              </div>
              <div class="header__user--item">
                <button id="회원가입" class="{% if active_button_id == '회원가입' %}active-button{% endif %}"><a href="{% url 'accounts:signup' %}">회원가입</a></button>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="{% static 'js/profile.js' %}"></script>
<script>
  $(document).ready(function() {
    var notificationContainer = $('#notification-container'); // notification-container 요소를 변수에 저장합니다.
    var notificationButton = $('#notification-button'); // 알림 버튼을 변수에 저장합니다.
  
    notificationButton.click(function(e) {
      e.preventDefault();
      if (notificationContainer.html().trim() === '') { // 알림 창이 비어있다면 AJAX 요청을 보냅니다.
        $.ajax({
          url: '{% url 'accounts:notification' %}',
          type: 'GET',
          success: function(response) {
            notificationContainer.html(response).show(); // 불러온 창을 표시합니다.
          },
          error: function(xhr) {
            console.log(xhr.responseText);
          }
        });
      } else {
        notificationContainer.empty().hide(); // 내용을 지우고 숨깁니다.
      }
    });
  });

  function toggleNotificationPopup() {
    const notificationPopup = document.getElementById("notification-popup");
    isNotificationPopupVisible = !isNotificationPopupVisible;
    notificationPopup.style.display = isNotificationPopupVisible ? "block" : "none";
    var popup = document.getElementById("notification-popup");
    if (popup.style.display === "none") {
      // 팝업이 숨겨져 있다면 AJAX 요청을 통해 알림 데이터를 가져옵니다.
      $.ajax({
        url: 'http://127.0.0.1:8000/accounts/notification/',
        type: 'GET',
        success: function(response) {
          // 알림 데이터를 팝업에 추가합니다.
          $("#notification-list").html(response);
          // 팝업을 표시합니다.
          popup.style.display = "block";
        },
        error: function(xhr) {
          console.log(xhr.responseText);
        }
      });
    } else {
      // 팝업이 표시되어 있다면 숨깁니다.
      popup.style.display = "none";
    }
  }  
</script>
<script>
  function showNotificationPopup() {
    const notificationPopup = document.getElementById("notification-popup");
    notificationPopup.style.display = "block";
  }
  
  function hideNotificationPopup() {
    const notificationPopup = document.getElementById("notification-popup");
    notificationPopup.style.display = "none";
  }

  $(document).ready(function() {
    var notificationContainer = $('#notification-popup');
    var notificationButton = $('#notification-button');
    var isNotificationPopupVisible = false;
  
    notificationButton.click(function(e) {
      e.preventDefault();
      toggleNotificationPopup();
    });
  
    function toggleNotificationPopup() {
      isNotificationPopupVisible = !isNotificationPopupVisible;
      notificationContainer.toggle(isNotificationPopupVisible);
    }
  });
  
  function markNotificationRead(notificationId) {
    $.ajax({
      url: '/accounts/notification/check/' + notificationId + '/',
      type: 'POST',
      data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
      success: function(response) {
        console.log('알림을 읽음으로 표시했습니다.');
        updateNotificationStatus(notificationId, true);
        updateNotificationCount(-1);
      },
      error: function(xhr) {
        console.log(xhr.responseText);
      }
    });
  }
  
  function deleteNotification(notificationId) {
    $.ajax({
      url: '/accounts/notification/delete/' + notificationId + '/',
      type: 'POST',
      data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
      success: function(response) {
        console.log('알림을 삭제했습니다.');
        removeNotificationFromList(notificationId);
        updateNotificationCount(-1); 
      },
      error: function(xhr) {
        console.log(xhr.responseText);
      }
    });
  }
  
  function updateNotificationStatus(notificationId, isRead) {
    var statusElement = $('#notification-status-' + notificationId);
    if (isRead) {
      statusElement.html('<span>읽음</span>');
    } else {
      statusElement.html('<button onclick="markNotificationRead(' + notificationId + ')">읽지 않음</button>');
    }
  }
  
  function removeNotificationFromList(notificationId) {
    var notificationElement = $('#notification-' + notificationId);
    notificationElement.remove();
    var notificationList = $('#notification-list');
    if (notificationList.children().length === 0) {
      notificationList.append('<li class="list-group-item">알림이 없습니다.</li>');
    }
  }
  
  function updateNotificationCount(change) {
    var notificationCountElement = $('#notification-count');
    var notificationCount = parseInt(notificationCountElement.text());
    notificationCount += change;
    if (notificationCount > 0) {
      notificationCountElement.html('<span id="fill"><i class="bi bi-bell-fill"></i>' + notificationCount + '</span>');
    } else {
      notificationCountElement.html('<span id="empty"><i class="bi bi-bell"></i>' + notificationCount + '</span>');
    }
  }
</script>

